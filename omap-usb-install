#!/bin/bash

#
# Install script to cold flash over USB using an image made of
# subimages for MLO, u-boot, script, dtb, zimage and initrd.
#
# If a sub-image is not specified, an empty one is created.
#
# This tool uses modified omap34usbboot.tar.gz that's available at:
# https://groups.google.com/forum/#!topic/pandaboard/9z5ebHEnuqs
#
# The MLO is generated by u-boot when it's compiled with:
# $ CONFIG_SPL=1 CROSS_COMPILE=arm-linux-gnueabi- make
#
# The u-boot install script is created from install.src with:
# $ mkimage -T script -C none -n "Install script" -d install.src u-boot.script
#
# The mkimage tool comes with u-boot or can be installed with
# u-boot-tools package.

SZ_512K=524288
SZ_1M=1048576
SZ_2M=2097152
SZ_8M=8388608
SZ_20M=20971520

generate_install_script() {
	if ! mkimage -A arm -T script -C none -n "Install script" -d boot.script boot.scr; then
		echo "ERRROR: could not mkimage install script"
		exit 1
	fi
}

pad_image() {
	file="$1"
	pad_size="$2"

	if [ ! -f $file ]; then
		echo "Creating empty $file"
		touch $file
	fi

	size=$(du -b "$file" | cut -f 1)
	if [ $size -gt $pad_size ]; then
		echo "ERROR: $file too big"
		exit 2
	fi

	if [ $size -lt $pad_size ]; then
		echo "Padding $file from $size to $pad_size"
		if ! truncate -s $pad_size $file; then
			echo "ERROR: truncate failed for $file"
			exit 3
		fi
	fi
}

generate_install_script
pad_image u-boot.bin $SZ_512K		# at 0x80008000
pad_image MLO $SZ_512K			# at 0x80088000
pad_image u-boot.img $SZ_512K		# at 0x80108000
pad_image boot.scr $SZ_512K		# at 0x80188000
pad_image dtb $SZ_2M			# at 0x80208000
pad_image zimage $SZ_8M			# at 0x80408000
pad_image initramfs $SZ_20M		# at 0x80c08000

if ! cat u-boot.bin MLO u-boot.img boot.scr dtb zimage initramfs > install-image; then
	echo "ERROR: failed to create install image"
	exit 3
fi

if ! sudo src/omap34usbboot/out/usbboot src/omap34usbboot/out/omap3_aboot install-image; then
	echo "ERROR: failed to flash install-image"
	exit 4
fi
