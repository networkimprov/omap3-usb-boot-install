fdtfile=dtb
bootfile=zimage
ramdisk=initramfs
fdtaddr=80a00000
tmpaddr=80b00000
loadaddr=80c00000
rdaddr=81600000
fdt_high=8c000000
initrd_high=ffffffff
bootpart=1:1
bootargs=console=ttyO2,115200n8 mpurate=800
mmcargs=setenv    bootargs ${bootargs} root=/dev/ram0 rw
distroargs=setenv bootargs ${bootargs} root=/dev/mmcblk1p2 rw rootfstype=ext4 rootwait rootflags=data=journal
nandargs=setenv   bootargs ${bootargs} root=ubi0:rootfs ubi.mtd=7,512 rootfstype=ubifs rootwait
mmcdev=1
# bootenv=uEnv.txt
# loadbootenv=fatload mmc ${mmcdev} ${loadaddr} ${bootenv}
# importbootenv=echo Importing environment from mmc ...; \
# 	env import -t $loadaddr $filesize

usb_state_check=i2c dev 1; i2c read 6b 8 1 ${tmpaddr}; \
	setexpr.w usb_state *${tmpaddr} \\& c0; \
	test ${usb_state} -eq 80;
# hex e10 = dec 3600 = 3.6 volts
min_voltage_threshold=e10
battery_state_check=i2c dev 1; i2c read 6b 9 1 ${tmpaddr}; \
	setexpr.w battery_state *${tmpaddr}; \
	test ${battery_state} -eq 0;
battery_voltage_check=i2c dev 1; i2c read 55 4 2 ${tmpaddr}; \
	setexpr.w voltage *${tmpaddr}; \
	test 0x${voltage} -gt 0x${min_voltage_threshold};

loadramdisk=fatload mmc ${mmcdev} ${rdaddr} ${ramdisk}
loadzimage=fatload mmc ${mmcdev} ${loadaddr} zImage
loadfdt=fatload mmc ${mmcdev} ${fdtaddr} ${fdtfile}
distro_fdt=ext4load mmc ${mmcdev}:2 ${fdtaddr} /boot/dtbs/anvl.dtb
distro_kernel=ext4load mmc ${mmcdev}:2 ${loadaddr} /boot/vmlinuz-linux-anvl
distro_initramfs=ext4load mmc ${mmcdev}:2 ${rdaddr} /boot/initramfs-linux-anvl.img
distroboot=echo Booting distro kernel from mmc...; \
	run distroargs; \
	run distro_kernel; \
	if run distro_initramfs; then \
		bootz ${loadaddr} ${rdaddr}:${filesize} ${fdtaddr}; \
	else \
		bootz ${loadaddr} - ${fdtaddr}; \
	fi
mmcboot=echo Booting from mmc ...; \
	run mmcargs; \
	run loadfdt; \
	run loadramdisk; \
	bootz ${loadaddr} ${rdaddr}:${filesize} ${fdtaddr}
nandboot=echo Booting from nand ...; \
	run nandargs; \
	nandecc sw; \
	nand read ${loadaddr} 580000 800000; \
	fdt addr ${fdtaddr}; \
	nand read ${fdtaddr}  380000 200000; \
	fdt resize; \
	nand read ${rdaddr} d80000 1400000; \
	bootz ${loadaddr} ${rdaddr}:1400000 ${fdtaddr}
preboot=echo Checking for install script; \
	if source 80980000; then \
		echo Install done; \
	else \
		echo No install script found; \
	fi
bootcmd=if run usb_state_check || run battery_voltage_check; then \
		mmc dev ${mmcdev}; \
		if mmc rescan; then \
			if run distro_fdt; then \
				run distroboot; \
			elif run loadzimage; then \
				run mmcboot; \
			else \
				run nandboot; \
			fi; \
		else \
			run nandboot; \
		fi; \
	else \
		echo "No USB or battery too low to boot. Aborting." \
	fi;
